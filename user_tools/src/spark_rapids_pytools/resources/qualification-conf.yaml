# Copyright (c) 2024-2025, NVIDIA CORPORATION.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

toolOutput:
  completeOutput: true
  subFolder:
  metricsSubFolder: raw_metrics
  textFormat:
    summaryLog:
      fileName: rapids_4_spark_qualification_output.log
    log4jFileName: qual_core_stderr.log
  csv:
    unsupportedOperatorsReport:
      fileName: rapids_4_spark_qualification_output_unsupportedOperators.csv
    clusterInformation:
      fileName: rapids_4_spark_qualification_output_cluster_information.csv
    stagesInformation:
      fileName: rapids_4_spark_qualification_output_stages.csv
    execsInformation:
      fileName: rapids_4_spark_qualification_output_execs.csv
    tunings:
      subFolder: tuning
    appsStatusReport:
        fileName: rapids_4_spark_qualification_output_status.csv
    summaryReport:
      fileName: rapids_4_spark_qualification_output.csv
      columns:
        - Vendor
        - Driver Host
        - Cluster Id
        - Cluster Name
        - App Name
        - App ID
        - Estimated GPU Speedup
        - Estimated GPU Duration
        - App Duration
        - SQL Stage Durations Sum
        - Unsupported Operators Stage Duration
        - Unsupported Operators Stage Duration Percent
        - Total Core Seconds
      mapColumns:
      groupColumns:
         enabled: false
         keys:
           - Vendor
           - Driver Host
           - Cluster Id
           - Cluster Name
           - App Name
         aggregate:
           - column: App Duration
             function: 'mean'
           - column: Estimated GPU Duration
             function: 'mean'
           - column: Unsupported Operators Stage Duration
             function: 'mean'
           - column: Skip by Heuristics
             function: 'any'
           - column: SQL Stage Durations Sum
             function: 'mean'
      dropDuplicates:
        - Vendor
        - Driver Host
        - Cluster Id
        - Cluster Name
        - App Name
sparkRapids:
  mvnUrl: 'https://repo1.maven.org/maven2/com/nvidia/rapids-4-spark-tools_2.12'
  repoUrl: '{}/{}/rapids-4-spark-tools_2.12-{}.jar'
  toolsJarRegex: 'rapids-4-spark-tools_2.12-.*.jar'
  mainClass: 'com.nvidia.spark.rapids.tool.qualification.QualificationMain'
  outputDocURL: 'https://docs.nvidia.com/spark-rapids/user-guide/latest/qualification/quickstart.html#qualification-output'
  enableAutoTuner: true
  requireEventLogs: true
  gpu:
    device: 't4'
    workersPerNode: 2
    cudaVersion: '11.5'
  cli:
    defaults:
      costSavingsSettings: #temporrary settings to control the code behavior until the cost savings feature is fully removed
        enabled: false
    toolOptions:
      - all
      - any
      - a
      - application-name
      - f
      - filter-criteria
      - fs-end-time
      - fs-start-time
      - h
      - html-report
      - no-html-report
      - m
      - match-event-logs
      - min-event-log-size
      - max-event-log-size
      - max-sql-desc-length
      - ml-functions
      - n
      - no-recursion
      - num-output-rows
      - order
      - r
      - report-read-schema
      - s
      - spark-property
      - speedup-factor-file
      - start-app-time
      - target-cluster-info
      - tuning-configs
      - timeout
      - u
      - user-name
local:
  output:
    cleanUp: true
    stdout:
      inaccurateSpeedupComment: 'Speed up estimations may be inaccurate because custom target worker information was provided.'
    files:
      summary:
        name: qualification_summary.csv
        outputComment: "Summarized speedups CSV report"
      statistics:
        name: qualification_statistics.csv
        outputComment: "Statistics CSV report"
        columns:
          - 'App ID'
          - 'SQL ID'
          - 'Operator'
          - 'Count'
          - 'Stage Task Exec Duration(s)'
          - 'Total SQL Task Duration(s)'
          - '% of Total SQL Task Duration'
          - 'Supported'
      intermediateOutput:
        name: 'intermediate_output'
        outputComment: "Intermediate output generated by tools"
        isDirectory: true
        files:
          heuristics:
            name: 'heuristics_info.csv'
            outputComment: "Heuristics information"
      configRecommendations:
        name: 'qual_core_output/tuning'
        columns:
          - 'Full Cluster Config Recommendations*'
          - 'GPU Config Recommendation Breakdown*'
      appMetadata:
        name: app_metadata.json
        outputComment: "Metadata file with cluster recommendation and tuning details"
        columns:
          - 'App ID'
          - 'App Name'
          - 'Event Log'
          - 'Cluster Info'
          - 'Spark Runtime'
          - 'Estimated GPU Speedup Category'
          - 'Full Cluster Config Recommendations*'
          - 'GPU Config Recommendation Breakdown*'
      appsStatusReport:
        name: 'qual_core_output/status.csv'
        outputComment: "Application status report"
    costColumns:
      - 'Savings Based Recommendation'
      - 'Estimated App Cost'
      - 'Estimated GPU Cost'
      - 'Estimated GPU Savings(%)'
      - 'Estimated Job Frequency (monthly)'
      - 'Annual Cost Savings'
    savingColumn: 'Estimated GPU Savings(%)'
    savingRecommendColumn: 'Savings Based Recommendation'
    summaryColumns: #columns to be displayed on the stdout as part of the final report
      savingsReportEnabledTrue: #columns with savings estimates enabled
        - 'App ID'
        - 'App Name'
        - 'Savings Based Recommendation'
        - 'App Duration'
        - 'Estimated GPU Duration'
        - 'Estimated GPU Speedup'
        - 'Estimated GPU Savings(%)'
      savingsReportEnabledFalse: #columns with savings estimates disabled
        - 'App ID'
        - 'App Name'
        - 'App Duration'
        - 'Estimated GPU Duration'
        - 'Estimated GPU Speedup'
    treeDirectory:
      enabled: true
      depthLevel: 2
      indentation: '    '
      excludedPatterns:
        directories:
          - '^(css)$'
          - '^(js)$'
          - '^(assets)$'
          - '.+\$$'
          - '^.+(_\$folder\$)$'
        files:
          - '^(\.+).*'
          - '^(\$+).*'
          - '^.+(_\$folder\$)$'
          - '^rapids_4_spark_qualification_output.*'
    unsupportedOperators:
      mask:
        - operator: 'NOT_EQUAL'
          columnName: 'Action'
          value: 'IgnoreNoPerf'
        - operator: 'NOT_EQUAL'
          columnName: 'Unsupported Type'
          value: 'Expr'
        - operator: 'NOT_EQUAL'
          columnName: 'Stage ID'
          value: -1
      inputColumns:
        - 'App ID'
        - 'App Duration'
        - 'Stage ID'
        - 'Stage Duration'
      groupingColumns:
        max:
          - 'App ID'
          - 'App Duration'
          - 'Stage ID'
        sum:
          - 'App ID'
          - 'App Duration'
      resultColumnName: 'Unsupported Operators Stage Duration'
      percentResultColumnName: 'Unsupported Operators Stage Duration Percent'
    topCandidates:
      categoryColumnName: 'Estimated GPU Speedup Category'
      outputColumns:
        - 'App ID'
        - 'App Name'
        - 'Estimated GPU Speedup Category'
        - 'Qualified Cluster Recommendation'
        - 'Full Cluster Config Recommendations*'
        - 'GPU Config Recommendation Breakdown*'
      ineligibleCategory:
        - 'Not Recommended'
      eligibleCategories:
        - 'Small'
        - 'Medium'
        - 'Large'
      sortingColumns:
        - 'Speedup Category Order'
        - 'Total Core Seconds'
        - 'Unsupported Operators Stage Duration Percent'
      joinColumns:
        - 'App ID'
        - 'App Name'
        - 'App Duration'
      summaryReport:
        compactWidth: true
        timeUnits: 's'
        columnWidth: 14
      totalCoreSecCol: 'Total Core Seconds'
      # This is total core seconds of an 8-core machine running for 24 hours
      totalCoreSecThreshold: !ENV ${RAPIDS_USER_TOOLS_CORE_SECONDS_THRESHOLD:691200}
    speedupCategories:
      speedupColumnName: 'Estimated GPU Speedup'
      categoryColumnName: 'Estimated GPU Speedup Category'
      heuristicsColumnName: 'Skip by Heuristics'
      sparkRuntimeColumnName: 'Spark Runtime'
      defaultCategory: 'Not Recommended'
      strategies:
        spark:  # Spark specific speedup categories
          categories:
            - title: 'Not Applicable'
              lowerBound: -1000000.0
              upperBound: 1.3
            - title: 'Small'
              lowerBound: 1.3
              upperBound: 2.0
            - title: 'Medium'
              lowerBound: 2.0
              upperBound: 3.0
            - title: 'Large'
              lowerBound: 3.0
              upperBound: 1000000.0
          eligibilityConditions:
            - columnName: 'Estimated GPU Speedup'
              lowerBound: !ENV ${RAPIDS_USER_TOOLS_GPU_SPEEDUP_SPARK_LOWER_BOUND:1.3}
              upperBound: !ENV ${RAPIDS_USER_TOOLS_GPU_SPEEDUP_SPARK_UPPER_BOUND:1000000.0}
              skippingReason: 'GPU SpeedUp < Qualifying Threshold (More is qualified)'
            - columnName: 'Unsupported Operators Stage Duration Percent'
              lowerBound: !ENV ${RAPIDS_USER_TOOLS_UNSUPPORTED_OPERATORS_SPARK_LOWER_BOUND:0.0}
              upperBound: !ENV ${RAPIDS_USER_TOOLS_UNSUPPORTED_OPERATORS_SPARK_UPPER_BOUND:25.0}
              skippingReason: 'Unsupported Operators Stage Duration Percent > Qualifying Threshold (Less is qualified)'
        photon:  # Photon specific speedup categories
          categories:
            - title: 'Not Applicable'
              lowerBound: -1000000.0
              upperBound: 1.0  # Lower threshold than Spark since Photon is faster and smaller speedups are valuable
            - title: 'Small'
              lowerBound: 1.0
              upperBound: 2.0
            - title: 'Medium'
              lowerBound: 2.0
              upperBound: 3.0
            - title: 'Large'
              lowerBound: 3.0
              upperBound: 1000000.0
          eligibilityConditions:
            - columnName: 'Estimated GPU Speedup'
              lowerBound: !ENV ${RAPIDS_USER_TOOLS_GPU_SPEEDUP_PHOTON_LOWER_BOUND:1.0}
              upperBound: !ENV ${RAPIDS_USER_TOOLS_GPU_SPEEDUP_PHOTON_UPPER_BOUND:1000000.0}
              skippingReason: 'GPU SpeedUp < Qualifying Threshold (Less is qualified)'
            - columnName: 'Unsupported Operators Stage Duration Percent'
              lowerBound: !ENV ${RAPIDS_USER_TOOLS_UNSUPPORTED_OPERATORS_PHOTON_LOWER_BOUND:0.0}
              upperBound: !ENV ${RAPIDS_USER_TOOLS_UNSUPPORTED_OPERATORS_PHOTON_UPPER_BOUND:25.0}
              skippingReason: 'Unsupported Operators Stage Duration Percent > Qualifying Threshold (Less is qualified)'
    additionalHeuristics:
      appInfo:
        fileName: 'application_information.csv'
      resultCols:
        - 'App ID'
        - 'Skip by Heuristics'
        - 'Not Recommended Reason'
      spillBased:
        stageAggMetrics:
          fileName: 'stage_level_aggregated_task_metrics.csv'
          columns:
            - 'stageId'
            - 'memoryBytesSpilled_sum'
        sqlToStageInfo:
          fileName: 'sql_to_stage_information.csv'
          columns:
            - 'stageId'
            - 'SQL Nodes(IDs)'
        spillThresholdBytes: !ENV ${RAPIDS_USER_TOOLS_SPILL_BYTES_THRESHOLD:1099511627776}
        allowedExecs:
          - 'Aggregate'
          - 'Join'
          - 'Sort'
    predictionModel:
      outputDirectory: 'xgboost_predictions'
      files:
        features:
          name: 'features.csv'
        perSql:
          name: 'per_sql.csv'
        perApp:
          name: 'per_app.csv'
        shapValues:
          name: 'shap_values.csv'
        featureImportance:
          name: 'feature_importance.csv'
      updateResult:
        subsetColumns:
          - 'appId'
          - 'speedup'
          - 'appDuration_pred'
        remapColumns:
          - srcCol: 'speedup'
            dstCol: 'Estimated GPU Speedup'
          - srcCol: 'appDuration_pred'
            dstCol: 'Estimated GPU Duration'
    clusterInference:
      cpuClusterColumns:
        - 'Num Worker Nodes'
        - 'Driver Node Type'
        - 'Worker Node Type'
        - 'Cores Per Executor'
      gpuClusterColumns:
        - 'Recommended Num Worker Nodes'
        - 'Recommended Driver Node Type'
        - 'Recommended Worker Node Type'
        - 'Recommended Cores Per Executor'

platform:
  shortName: 'qual'
  outputDir: qual-tool-output
  # Whether or not the temp directories should be cleaned up. For example,
  # the temporary folder for each run will be cleaned-up.
  # Set that to false if we need to troubleshoot the workdir/dependencies.
  cleanUp: !ENV ${RAPIDS_USER_TOOLS_CLEAN_UP:true}
